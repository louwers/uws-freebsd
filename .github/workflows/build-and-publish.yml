name: Build and Release uWebSockets.js

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      source_commit: ${{ steps.get-commit.outputs.source_commit }}
      should_build: ${{ steps.check-release.outputs.should_build }}
    permissions:
      contents: read
    
    steps:
      - name: Get latest uWebSockets.js version
        id: get-version
        run: |
          # Fetch the latest release tag from uNetworking/uWebSockets.js
          LATEST_VERSION=$(gh release view --repo uNetworking/uWebSockets.js --json tagName --jq .tagName)
          echo "Latest version: $LATEST_VERSION"
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download and extract source_commit
        id: get-commit
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          # Download the archive using gh
          gh release download "$VERSION" \
            --repo uNetworking/uWebSockets.js \
            --archive=zip \
            --output uws.zip
          
          # Extract the archive
          unzip -q uws.zip
          
          # Find and read source_commit file
          EXTRACTED_DIR="uWebSockets.js-${VERSION#v}"
          if [ -f "$EXTRACTED_DIR/source_commit" ]; then
            SOURCE_COMMIT=$(cat "$EXTRACTED_DIR/source_commit")
            echo "Source commit: $SOURCE_COMMIT"
            echo "source_commit=$SOURCE_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "Warning: source_commit file not found"
            echo "source_commit=" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check if release exists
        id: check-release
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          # Check if a release with this version already exists in this repo
          if gh release view "$VERSION" --repo ${{ github.repository }} >/dev/null 2>&1; then
            echo "Release $VERSION already exists, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          else
            echo "Release $VERSION does not exist, proceeding with build"
            echo "should_build=true" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  build-freebsd:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
      
      - name: Checkout uWebSockets.js repository
        uses: actions/checkout@v4
        with:
          repository: uNetworking/uWebSockets.js
          submodules: recursive
          path: uWebSockets.js
          ref: ${{ needs.check-version.outputs.source_commit }}
      
      - name: Build in FreeBSD VM
        uses: acj/freebsd-firecracker-action@v0.6.0
        with:
          disk-size: 4G
          run-in-vm: |
            # Apply FreeBSD patch
            # Force output to stderr so it's captured
            exec 2>&1
            set -x
            echo "=== DEBUG START ===" >&2
            echo "Current directory: $(pwd)" >&2
            echo "Listing files:" >&2
            ls -la >&2
            echo "Searching for uWebSockets.js:" >&2
            find . -type d -name "uWebSockets.js" 2>&1 || echo "uWebSockets.js not found" >&2
            cd uWebSockets.js 2>/dev/null || {
              echo "Error: uWebSockets.js directory not found in $(pwd)" >&2
              echo "Contents of current directory:" >&2
              ls -la >&2
              echo "Searching from /root:" >&2
              find /root -type d -name "uWebSockets.js" 2>&1 | head -5
              exit 1
            }
            echo "In uWebSockets.js directory: $(pwd)" >&2
            echo "Files in uWebSockets.js:" >&2
            ls -la >&2
            echo "Searching for build.c:" >&2
            find . -name "build.c" -type f 2>&1 | head -5
            if [ ! -f build.c ]; then
              echo "Error: build.c file not found in $(pwd)" >&2
              echo "Searching for build.c recursively:" >&2
              find . -name "build.c" -type f 2>&1 || echo "build.c not found anywhere" >&2
              exit 1
            fi
            echo "=== Found build.c, proceeding ===" >&2
            echo '#define __linux 1' > build.c.temp
            cat build.c >> build.c.temp || { echo "Warning: Could not read build.c, using new content only"; }
            mv build.c.temp build.c
            sed -i.bak 's|#define OS "linux"|#define OS "freebsd"|' build.c && rm -f build.c.bak
            sed -i.bak 's/clang-18/clang18/' build.c && rm -f build.c.bak
            sed -i.bak 's/clang++-18/clang++18/' build.c && rm -f build.c.bak
            
            # Install dependencies and build
            pkg install -y cmake llvm18 libuv
            make
      
      - name: List built files
        run: |
          cd uWebSockets.js
          if [ -d "dist" ]; then
            ls -lh dist/
          else
            echo "Warning: dist directory not found"
            exit 1
          fi
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.version }}
          name: ${{ needs.check-version.outputs.version }}
          files: uWebSockets.js/dist/uws_freebsd_x64_*.node
          draft: false
          prerelease: false
          body: |
            FreeBSD build of uWebSockets.js ${{ needs.check-version.outputs.version }}
            
            Source commit: https://github.com/uNetworking/uWebSockets.js/commit/${{ needs.check-version.outputs.source_commit }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
