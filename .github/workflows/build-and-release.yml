name: Build and Release uWebSockets.js

on:
  pull_request:
  workflow_dispatch:
    inputs:
      uwebsockets_version:
        description: 'uWebSockets.js version tag (e.g., v20.55.0)'
        required: true
        type: string

jobs:
  ensure-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.release.outputs.tag }}

    steps:
      - name: Create or ensure release exists
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ inputs.uwebsockets_version }}
        run: |
          echo "tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"

          # Check if release exists
          if gh release view "$RELEASE_TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Release $RELEASE_TAG already exists"
          else
            echo "Creating release $RELEASE_TAG"
            gh release create "$RELEASE_TAG" \
              --repo ${{ github.repository }} \
              --title "uWebSockets.js $RELEASE_TAG" \
              --notes "Binary builds of uWebSockets.js $RELEASE_TAG for FreeBSD, Linux, and macOS" \
              --draft false \
              --prerelease false
          fi

  build-freebsd:
    runs-on: ubuntu-latest
    needs: ensure-release
    if: always() && (github.event_name == 'pull_request' || needs.ensure-release.result == 'success')
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout uWebSockets.js repository
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git clone --recursive --branch ${{ inputs.uwebsockets_version }} https://github.com/uNetworking/uWebSockets.js.git
          else
            git clone --recursive https://github.com/uNetworking/uWebSockets.js.git --depth 1
          fi

      - name: Prepare build.c for FreeBSD
        run: |
          cd uWebSockets.js
          # Prepend FreeBSD defines to build.c to make it build as Linux
          # This allows FreeBSD to use Linux build paths while producing freebsd-named binaries
          { echo '#define OS "freebsd"'; echo '#define __linux 1'; cat build.c; } > build.c.tmp
          mv build.c.tmp build.c

      - name: Build in FreeBSD VM
        uses: vmactions/freebsd-vm@v1
        with:
          usesh: true
          prepare: |
            pkg install -y cmake llvm18
          run: |
            cd uWebSockets.js
            make

      - name: List built files
        run: |
          cd uWebSockets.js
          if [ -d "dist" ]; then
            ls -lh dist/
          else
            echo "Warning: dist directory not found"
            exit 1
          fi

      - name: Upload FreeBSD binaries to release
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ needs.ensure-release.outputs.release_tag }}"
          cd uWebSockets.js/dist
          for file in uws_freebsd_x64_*.node; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $RELEASE_TAG"
              gh release upload "$RELEASE_TAG" "$file" \
                --repo ${{ github.repository }} \
                --clobber
            fi
          done

  build-linux:
    runs-on: ubuntu-latest
    needs: ensure-release
    if: always() && (github.event_name == 'pull_request' || needs.ensure-release.result == 'success')
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout uWebSockets.js repository
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git clone --recursive --branch ${{ inputs.uwebsockets_version }} https://github.com/uNetworking/uWebSockets.js.git
          else
            git clone --recursive https://github.com/uNetworking/uWebSockets.js.git --depth 1
          fi

      - name: Build for Linux
        run: |
          cd uWebSockets.js
          make

      - name: List built files
        run: |
          cd uWebSockets.js
          if [ -d "dist" ]; then
            ls -lh dist/
          else
            echo "Warning: dist directory not found"
            exit 1
          fi

      - name: Upload Linux binaries to release
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ needs.ensure-release.outputs.release_tag }}"
          cd uWebSockets.js/dist
          for file in uws_linux_x64_*.node; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $RELEASE_TAG"
              gh release upload "$RELEASE_TAG" "$file" \
                --repo ${{ github.repository }} \
                --clobber
            fi
          done

  build-macos:
    runs-on: macos-latest
    needs: ensure-release
    if: always() && (github.event_name == 'pull_request' || needs.ensure-release.result == 'success')
    permissions:
      contents: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Checkout uWebSockets.js repository
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git clone --recursive --branch ${{ inputs.uwebsockets_version }} https://github.com/uNetworking/uWebSockets.js.git
          else
            git clone --recursive https://github.com/uNetworking/uWebSockets.js.git --depth 1
          fi

      - name: Build for macOS
        run: |
          ls
          cd uWebSockets.js
          make

      - name: List built files
        run: |
          cd uWebSockets.js
          if [ -d "dist" ]; then
            ls -lh dist/
          else
            echo "Warning: dist directory not found"
            exit 1
          fi

      - name: Upload macOS binaries to release
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ needs.ensure-release.outputs.release_tag }}"
          cd uWebSockets.js/dist
          for file in uws_darwin_*.node; do
            if [ -f "$file" ]; then
              echo "Uploading $file to release $RELEASE_TAG"
              gh release upload "$RELEASE_TAG" "$file" \
                --repo ${{ github.repository }} \
                --clobber
            fi
          done
